<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>BookmarkRegister</title>
    <style>
        body {
            display: flex;
            flex-direction: column;  /* 위에서 아래로 배치 */
            justify-content: center; /* 세로 중앙 */
            align-items: center;     /* 가로 중앙 */
            min-height: 100vh;       /* 화면 전체 높이 */
            margin: 0;               /* 여백 제거 */
        }
        form {
            display: flex;          /* 입력칸 그룹 + 버튼 가로 배치 */
            align-items: stretch;   /* 높이 동일 */
            gap: 10px;              /* 입력칸과 버튼 사이 간격 */
            margin-bottom: 15px;
        }
        .form-fields {
            display: flex;
            flex-direction: column; /* 이름 / URL 세로 배치 */
            gap: 10px;
        }
        .form-group {
            display: flex;
            align-items: center;    /* 라벨과 입력칸 같은 줄 */
        }
        label {
            display: inline-block;
            width: 120px;           /* 라벨 고정 폭 */
        }
        input[type="text"] {
            width: 250px;
        }
        input[type="submit"] {
            width: 100px;
            font-size: 16px;
        }
        button {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<form onsubmit="return addBookmarkRequest();">
    <div class="form-fields">
        <div class="form-group">
            <label for="name">즐겨찾기 이름</label>
            <input type="text" id="name" name="name">
        </div>
        <div class="form-group">
            <label for="url">URL</label>
            <input type="text" id="url" name="url">
        </div>
    </div>
    <!-- 입력칸 두 줄 높이에 맞춘 제출 버튼 -->
    <input type="submit" value="등록">
</form>

<button onclick="getBookmarkListRequest();">즐겨찾기 목록 가져오기</button>
<ol id="bookmark-list">
    <!-- 여기에 즐겨찾기 목록 나옵니다. -->
</ol>

<script>
    function addBookmarkRequest() {
        const name = document.querySelector('input[name=name]').value;
        const url = document.querySelector('input[name=url]').value;
        const normalizedUrl = normalizeUrl(url);

        const requestObject = { name: name, url: normalizedUrl };
        const requestJson = JSON.stringify(requestObject);

        function onReadyStateChange(event) {
            const currentAjaxRequest = event.currentTarget;
            if (currentAjaxRequest.readyState === XMLHttpRequest.DONE) {
                if (currentAjaxRequest.status === 200) {
                    alert("즐겨찾기가 등록되었어요!");
                } else {
                    console.error('즐겨찾기 등록 실패');
                }
            }
        }

        const ajaxRequest = new XMLHttpRequest();
        ajaxRequest.onreadystatechange = onReadyStateChange;
        ajaxRequest.open('POST', '/bookmark');
        ajaxRequest.setRequestHeader('Content-Type', 'application/json');
        ajaxRequest.send(requestJson);

        return false;
    }

    function getBookmarkListRequest() {
        function onReadyStateChange(event) {
            const currentAjaxRequest = event.currentTarget;
            if (currentAjaxRequest.readyState === XMLHttpRequest.DONE) {
                if (currentAjaxRequest.status === 200) {
                    const bookmarkListDom = document.querySelector('#bookmark-list');
                    bookmarkListDom.innerHTML = '';

                    const bookmarkList = JSON.parse(currentAjaxRequest.responseText);
                    bookmarkList.forEach(bookmark => {
                        const liNode = document.createElement('li');

                        //이름 - URL 텍스트
                        const textNode = document.createTextNode(bookmark.name + ' - ' + bookmark.url);

                        //바로가기 링크
                        const aNode = document.createElement('a');
                        aNode.href = bookmark.url;
                        aNode.textContent = "<바로가기>";
                        aNode.target = "_blank";

                        //삭제 버튼
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = "삭제";
                        deleteButton.onclick = () => deleteBookmark(bookmark.id);

                        //수정 버튼
                        const editButton = document.createElement('button');
                        editButton.textContent = "수정";
                        editButton.onclick = () => editBookmark(bookmark.id);
                        liNode.appendChild(editButton);


                        liNode.appendChild(textNode);
                        liNode.appendChild(aNode);
                        liNode.appendChild(deleteButton);

                        bookmarkListDom.appendChild(liNode);


                    });
                } else {
                    console.error('request failed');
                }
            }
        }

        const ajaxRequest = new XMLHttpRequest();
        ajaxRequest.onreadystatechange = onReadyStateChange;
        ajaxRequest.open('GET', '/bookmarkList');
        ajaxRequest.send();
    }

    function normalizeUrl (url) {
    if (!(url.startsWith("http://") || url.startsWith("https://")))
        return "https://" + url;
    else if(url.startsWith("http://"))
        return url.replace("http://", "https://");

    return url;
    }

    function deleteBookmark(id) {
    const ajaxRequest = new XMLHttpRequest();
    ajaxRequest.open('DELETE', '/bookmark/' + id);
    ajaxRequest.onload = function() {
        if (ajaxRequest.status === 200) {
            alert("삭제 성공!");
            getBookmarkListRequest();
        } else {
            console.error("삭제 실패");
        }
    };
    ajaxRequest.send();
}

    function editBookmark(id) {
    const newName = prompt("새 이름을 입력하세요:");
    const newUrl = prompt("새 URL을 입력하세요:");

    if (!newName || !newUrl) {
        alert("값을 입력해야 합니다!");
        return;
    }

    const normalizedUrl = normalizeUrl(newUrl);

    const requestObject = { name: newName, url: normalizedUrl };
    const requestJson = JSON.stringify(requestObject);

    const ajaxRequest = new XMLHttpRequest();
    ajaxRequest.open('PUT', '/bookmark/' + id);
    ajaxRequest.setRequestHeader('Content-Type', 'application/json');
    ajaxRequest.onload = function() {
        if (ajaxRequest.status === 200) {
            alert("수정 성공!");
            getBookmarkListRequest(); // 목록 새로고침
        } else {
            console.error("수정 실패");
        }
    };
    ajaxRequest.send(requestJson);
}


</script>
</body>
</html>
